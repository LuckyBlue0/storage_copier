(()=>{console.log("🚀 Storage Copier background script loaded");let e=null,o=null;async function t(e,o="info"){const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});t&&await chrome.scripting.executeScript({target:{tabId:t.id,allFrames:!0},function:(e,o)=>{let t=document.getElementById("storage-copier-toast-container");t||(t=document.createElement("div"),t.id="storage-copier-toast-container",t.style.cssText="\n          position: fixed;\n          top: 20px;\n          right: 20px;\n          z-index: 10000;\n          font-family: Arial, sans-serif;\n        ",document.body.appendChild(t));const r=document.createElement("div");switch(r.style.cssText="\n        margin-bottom: 10px;\n        padding: 12px 24px;\n        border-radius: 4px;\n        color: white;\n        font-size: 14px;\n        box-shadow: 0 2px 5px rgba(0,0,0,0.2);\n        animation: slideIn 0.5s ease-out;\n      ",o){case"success":r.style.backgroundColor="#4CAF50";break;case"error":r.style.backgroundColor="#f44336";break;case"warning":r.style.backgroundColor="#ff9800";break;default:r.style.backgroundColor="#2196F3"}r.textContent=e;const n=document.createElement("style");n.textContent="\n        @keyframes slideIn {\n          from {\n            transform: translateX(100%);\n            opacity: 0;\n          }\n          to {\n            transform: translateX(0);\n            opacity: 1;\n          }\n        }\n        @keyframes slideOut {\n          from {\n            transform: translateX(0);\n            opacity: 1;\n          }\n          to {\n            transform: translateX(100%);\n            opacity: 0;\n          }\n        }\n      ",document.head.appendChild(n),t.appendChild(r),setTimeout((()=>{r.style.animation="slideOut 0.5s ease-in forwards",r.addEventListener("animationend",(()=>{r.parentNode&&(t.removeChild(r),0===t.children.length&&t.parentNode&&document.body.removeChild(t))}))}),3e3)},args:[e,o]})}function r(e,o){const t=new URL(o),r={url:t.origin+(e.path||"/"),name:e.name,value:e.value,path:e.path||"/"};if(e.domain){let o=e.domain.startsWith(".")?e.domain.slice(1):e.domain;t.hostname.endsWith(o)&&(r.domain=o)}"https:"===t.protocol?r.secure=!1!==e.secure:r.secure=Boolean(e.secure);let n=(e.sameSite||"lax").toLowerCase();return["strict","lax","none"].includes(n)||(n="lax"),"none"===n&&(r.secure=!0),r.sameSite=n,r.httpOnly=Boolean(e.httpOnly),e.expirationDate&&"number"==typeof e.expirationDate&&e.expirationDate>Date.now()/1e3&&(r.expirationDate=e.expirationDate),r}chrome.runtime.onInstalled.addListener((()=>{console.log("📋 Creating context menus..."),chrome.contextMenus.create({id:"copySessionStorage",title:"复制会话存储数据",contexts:["page","frame"]}),chrome.contextMenus.create({id:"importSessionStorage",title:"导入会话存储数据",contexts:["page","frame"]}),chrome.contextMenus.create({id:"copyCookies",title:"复制Cookie数据",contexts:["page","frame"]}),chrome.contextMenus.create({id:"importCookies",title:"导入Cookie数据",contexts:["page","frame"]})})),chrome.commands.onCommand.addListener((async e=>{console.log("⌨️ Command received:",e);try{const[n]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!n)return console.error("❌ No active tab found"),void await t("错误：没有找到活动标签页","error");switch(console.log("📑 Current tab:",n.url),e){case"copy-cookies":console.log("🍪 Copying cookies...");const a=new URL(n.url),s=await chrome.cookies.getAll({domain:a.hostname});if(console.log(`📊 Found ${s.length} cookies`),s&&s.length>0){const e=function(e){const o=e.map((e=>({name:e.name||"",value:e.value||"",domain:e.domain||"",path:e.path||"/",secure:Boolean(e.secure),httpOnly:Boolean(e.httpOnly),sameSite:e.sameSite||"lax",...e.expirationDate?{expirationDate:e.expirationDate}:{}})));return JSON.stringify(o,null,2)}(s);console.log("📋 Cookie data generated:",e),await chrome.scripting.executeScript({target:{tabId:n.id},function:e=>{try{const o=document.createElement("textarea");o.value=e,o.style.position="fixed",o.style.left="-9999px",document.body.appendChild(o),o.select();const t=document.execCommand("copy");return document.body.removeChild(o),t}catch(e){return console.error("复制失败:",e),!1}},args:[e]}).then((async e=>{const o=e[0]?.result;console.log(o?"✅ Copied to clipboard":"❌ Copy failed"),await t(o?"已复制所有Cookie":"Cookie复制失败",o?"success":"error")}))}else console.log("⚠️ No cookies found"),await t("没有找到可复制的Cookie","error");break;case"import-cookies":console.log("🔄 Importing cookies...");const c=await chrome.scripting.executeScript({target:{tabId:n.id},function:()=>{try{const e=document.createElement("textarea");e.style.position="fixed",e.style.left="-9999px",document.body.appendChild(e),e.focus();const o=document.execCommand("paste"),t=e.value;return document.body.removeChild(e),{success:o,text:t}}catch(e){return console.error("粘贴失败:",e),{success:!1,text:""}}}}),{success:i,text:l}=c[0].result;if(console.log(i?"✅ Read from clipboard":"❌ Paste failed"),console.log("📋 Clipboard content:",l),!i||!l){console.error("❌ Failed to read clipboard"),await t("无法读取剪贴板数据","error");break}try{let e;try{e=JSON.parse(l)}catch(e){console.error("❌ Invalid JSON format:",e),console.log("Invalid content:",l),await t("剪贴板中的数据格式无效","error");break}if(Array.isArray(e)){console.log(`📥 Importing ${e.length} cookies...`);let o=0,a=0,s=0;for(const t of e)try{const e=r(t,n.url);console.log("🍪 Setting cookie:",e),await chrome.cookies.set(e),o++,console.log(`✅ Set cookie: ${t.name}`)}catch(e){console.error(`❌ Failed to set cookie: ${t.name}`,e),console.log("Problem cookie:",t),a++}const c=`成功导入 ${o} 个Cookie${a>0?`，${a} 个失败`:""}${s>0?`，${s} 个跳过`:""}`;console.log(`📊 Import complete: ${c}`),await t(c,0===a?"success":"warning")}else console.error("❌ Invalid data format: not an array"),await t("剪贴板中的数据格式无效","error")}catch(e){console.error("❌ Failed to parse cookie data:",e),await t("导入失败：数据格式错误","error")}break;case"copy-session-storage":console.log("🎯 通过快捷键触发复制操作"),chrome.tabs.query({active:!0,currentWindow:!0},(async function(e){if(e[0])try{const r=await chrome.scripting.executeScript({target:{tabId:e[0].id,allFrames:!0},function:()=>{const e={};for(let o=0;o<sessionStorage.length;o++){const t=sessionStorage.key(o);e[t]=sessionStorage.getItem(t)}return{frameId:window.frameElement?window.frameElement.id:0,data:e}}});r&&r.length>0?(o=r,console.log("📦 会话存储数据已保存到内存中"),await t("会话存储数据已复制！","success")):(console.log("❌ 未找到任何会话存储数据"),o=null,await t("没有找到会话存储数据","error"))}catch(e){console.error("复制会话存储失败:",e),o=null,await t("复制会话存储失败，请查看控制台了解详情","error")}else console.error("❌ 没有找到活动标签页")}));break;case"import-session-storage":console.log("🎯 通过快捷键触发导入操作");try{if(!o)return console.log("❌ 没有可导入的数据"),void await t("没有可导入的数据","error");await chrome.scripting.executeScript({target:{tabId:n.id},function:e=>{try{return e.forEach((e=>{const o=e.result.data;Object.entries(o).forEach((([e,o])=>{try{sessionStorage.setItem(e,o),console.log("✅ 成功导入:",e)}catch(o){console.error("❌ 导入失败:",e,o)}}))})),!0}catch(e){return console.error("导入过程中出错:",e),!1}},args:[o]}),console.log("✅ 导入完成"),await t("会话存储数据已导入！","success")}catch(e){console.error("导入会话存储失败:",e),await t("导入会话存储失败，请查看控制台了解详情","error")}break;default:console.log("⚠️ Unknown command:",e)}}catch(e){console.error("❌ Command execution failed:",e),await t("操作失败: "+e.message,"error")}})),chrome.contextMenus.onClicked.addListener((async(r,n)=>{if("copySessionStorage"===r.menuItemId){console.log("🎯 触发复制会话存储操作");try{const e=await chrome.scripting.executeScript({target:{tabId:n.id,allFrames:!0},function:()=>{const e={};for(let o=0;o<sessionStorage.length;o++){const t=sessionStorage.key(o);e[t]=sessionStorage.getItem(t)}return{frameId:window.frameElement?window.frameElement.id:0,data:e}}});e&&e.length>0?(o=e,console.log("📦 会话存储数据已保存到内存中"),await t("会话存储数据已复制！","success")):(console.log("❌ 未找到任何会话存储数据"),o=null,await t("没有找到会话存储数据","error"))}catch(e){console.error("复制会话存储失败:",e),o=null,await t("复制会话存储失败，请查看控制台了解详情","error")}}else if("importSessionStorage"===r.menuItemId){console.log("🎯 触发导入会话存储操作");try{if(!o)return console.log("❌ 没有可导入的数据"),void await t("没有可导入的数据","error");await chrome.scripting.executeScript({target:{tabId:n.id},function:e=>{try{return e.forEach((e=>{const o=e.result.data;Object.entries(o).forEach((([e,o])=>{try{sessionStorage.setItem(e,o),console.log("✅ 成功导入:",e)}catch(o){console.error("❌ 导入失败:",e,o)}}))})),!0}catch(e){return console.error("导入过程中出错:",e),!1}},args:[o]}),console.log("✅ 导入完成"),await t("会话存储数据已导入！","success")}catch(e){console.error("导入会话存储失败:",e),await t("导入会话存储失败，请查看控制台了解详情","error")}}else if("copyCookies"===r.menuItemId){if(console.log("🎯 触发复制Cookie操作"),!n)return void console.error("❌ 没有找到活动标签页");try{const o=new URL(n.url);console.log(`🔍 开始获取Cookies，URL: ${n.url}`);const r=await chrome.cookies.getAll({domain:o.hostname});console.log(`获取到 ${r.length} 个cookies:`,r),r.length>0?(e=r,console.log("📦 Cookie数据已保存到内存中"),await t(`成功复制 ${r.length} 个 cookies！`,"success")):(console.log("❌ 未找到任何cookies"),e=null,await t("未找到任何 cookies","error"))}catch(o){console.error("复制Cookie失败:",o),e=null,await t("复制Cookie失败，请查看控制台了解详情","error")}}else if("importCookies"===r.menuItemId){if(console.log("🎯 触发导入Cookie操作"),!n||!e)return console.error("❌ 没有找到活动标签页或没有可导入的Cookie数据"),void await t("没有可导入的Cookie数据","error");try{const o=new URL(n.url).hostname;console.log(`准备导入Cookie到域名: ${o}`);let r=0,a=0;for(const t of e)try{const e={name:t.name,value:t.value,domain:o,path:t.path||"/",secure:t.secure||!1,httpOnly:t.httpOnly||!1,sameSite:t.sameSite||"lax",url:n.url};t.expirationDate&&(e.expirationDate=t.expirationDate),console.log(`正在设置cookie: ${e.name}`),await chrome.cookies.set(e),r++}catch(e){a++,console.error("设置cookie失败:",e)}r>0?await t(`成功导入 ${r} 个 cookies！${a>0?` (${a}个失败)`:""}`,"success"):await t("没有成功导入任何 cookies "+(a>0?` (${a}个失败)`:""),"error")}catch(e){console.error("导入Cookie失败:",e),await t("导入Cookie失败，请查看控制台了解详情","error")}}})),chrome.runtime.onMessage.addListener(((o,t,r)=>(console.log("📨 收到消息:",o),"storeCookies"===o.type?(e=o.cookies,r({success:!0})):"getCookies"===o.type&&r({cookies:e}),!0)))})();