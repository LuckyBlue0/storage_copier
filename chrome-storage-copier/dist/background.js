(()=>{console.log("ğŸš€ Storage Copier background script loaded");let e=null,o=null;async function t(e,o="info"){const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});t&&await chrome.scripting.executeScript({target:{tabId:t.id,allFrames:!0},function:(e,o)=>{let t=document.getElementById("storage-copier-toast-container");t||(t=document.createElement("div"),t.id="storage-copier-toast-container",t.style.cssText="\n          position: fixed;\n          top: 20px;\n          right: 20px;\n          z-index: 10000;\n          font-family: Arial, sans-serif;\n        ",document.body.appendChild(t));const r=document.createElement("div");switch(r.style.cssText="\n        margin-bottom: 10px;\n        padding: 12px 24px;\n        border-radius: 4px;\n        color: white;\n        font-size: 14px;\n        box-shadow: 0 2px 5px rgba(0,0,0,0.2);\n        animation: slideIn 0.5s ease-out;\n      ",o){case"success":r.style.backgroundColor="#4CAF50";break;case"error":r.style.backgroundColor="#f44336";break;case"warning":r.style.backgroundColor="#ff9800";break;default:r.style.backgroundColor="#2196F3"}r.textContent=e;const n=document.createElement("style");n.textContent="\n        @keyframes slideIn {\n          from {\n            transform: translateX(100%);\n            opacity: 0;\n          }\n          to {\n            transform: translateX(0);\n            opacity: 1;\n          }\n        }\n        @keyframes slideOut {\n          from {\n            transform: translateX(0);\n            opacity: 1;\n          }\n          to {\n            transform: translateX(100%);\n            opacity: 0;\n          }\n        }\n      ",document.head.appendChild(n),t.appendChild(r),setTimeout((()=>{r.style.animation="slideOut 0.5s ease-in forwards",r.addEventListener("animationend",(()=>{r.parentNode&&(t.removeChild(r),0===t.children.length&&t.parentNode&&document.body.removeChild(t))}))}),3e3)},args:[e,o]})}function r(e,o){const t=new URL(o),r={url:t.origin+(e.path||"/"),name:e.name,value:e.value,path:e.path||"/"};if(e.domain){let o=e.domain.startsWith(".")?e.domain.slice(1):e.domain;t.hostname.endsWith(o)&&(r.domain=o)}"https:"===t.protocol?r.secure=!1!==e.secure:r.secure=Boolean(e.secure);let n=(e.sameSite||"lax").toLowerCase();return["strict","lax","none"].includes(n)||(n="lax"),"none"===n&&(r.secure=!0),r.sameSite=n,r.httpOnly=Boolean(e.httpOnly),e.expirationDate&&"number"==typeof e.expirationDate&&e.expirationDate>Date.now()/1e3&&(r.expirationDate=e.expirationDate),r}chrome.runtime.onInstalled.addListener((()=>{console.log("ğŸ“‹ Creating context menus..."),chrome.contextMenus.create({id:"copySessionStorage",title:"å¤åˆ¶ä¼šè¯å­˜å‚¨æ•°æ®",contexts:["page","frame"]}),chrome.contextMenus.create({id:"importSessionStorage",title:"å¯¼å…¥ä¼šè¯å­˜å‚¨æ•°æ®",contexts:["page","frame"]}),chrome.contextMenus.create({id:"copyCookies",title:"å¤åˆ¶Cookieæ•°æ®",contexts:["page","frame"]}),chrome.contextMenus.create({id:"importCookies",title:"å¯¼å…¥Cookieæ•°æ®",contexts:["page","frame"]})})),chrome.commands.onCommand.addListener((async e=>{console.log("âŒ¨ï¸ Command received:",e);try{const[n]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!n)return console.error("âŒ No active tab found"),void await t("é”™è¯¯ï¼šæ²¡æœ‰æ‰¾åˆ°æ´»åŠ¨æ ‡ç­¾é¡µ","error");switch(console.log("ğŸ“‘ Current tab:",n.url),e){case"copy-cookies":console.log("ğŸª Copying cookies...");const a=new URL(n.url),s=await chrome.cookies.getAll({domain:a.hostname});if(console.log(`ğŸ“Š Found ${s.length} cookies`),s&&s.length>0){const e=function(e){const o=e.map((e=>({name:e.name||"",value:e.value||"",domain:e.domain||"",path:e.path||"/",secure:Boolean(e.secure),httpOnly:Boolean(e.httpOnly),sameSite:e.sameSite||"lax",...e.expirationDate?{expirationDate:e.expirationDate}:{}})));return JSON.stringify(o,null,2)}(s);console.log("ğŸ“‹ Cookie data generated:",e),await chrome.scripting.executeScript({target:{tabId:n.id},function:e=>{try{const o=document.createElement("textarea");o.value=e,o.style.position="fixed",o.style.left="-9999px",document.body.appendChild(o),o.select();const t=document.execCommand("copy");return document.body.removeChild(o),t}catch(e){return console.error("å¤åˆ¶å¤±è´¥:",e),!1}},args:[e]}).then((async e=>{const o=e[0]?.result;console.log(o?"âœ… Copied to clipboard":"âŒ Copy failed"),await t(o?"å·²å¤åˆ¶æ‰€æœ‰Cookie":"Cookieå¤åˆ¶å¤±è´¥",o?"success":"error")}))}else console.log("âš ï¸ No cookies found"),await t("æ²¡æœ‰æ‰¾åˆ°å¯å¤åˆ¶çš„Cookie","error");break;case"import-cookies":console.log("ğŸ”„ Importing cookies...");const c=await chrome.scripting.executeScript({target:{tabId:n.id},function:()=>{try{const e=document.createElement("textarea");e.style.position="fixed",e.style.left="-9999px",document.body.appendChild(e),e.focus();const o=document.execCommand("paste"),t=e.value;return document.body.removeChild(e),{success:o,text:t}}catch(e){return console.error("ç²˜è´´å¤±è´¥:",e),{success:!1,text:""}}}}),{success:i,text:l}=c[0].result;if(console.log(i?"âœ… Read from clipboard":"âŒ Paste failed"),console.log("ğŸ“‹ Clipboard content:",l),!i||!l){console.error("âŒ Failed to read clipboard"),await t("æ— æ³•è¯»å–å‰ªè´´æ¿æ•°æ®","error");break}try{let e;try{e=JSON.parse(l)}catch(e){console.error("âŒ Invalid JSON format:",e),console.log("Invalid content:",l),await t("å‰ªè´´æ¿ä¸­çš„æ•°æ®æ ¼å¼æ— æ•ˆ","error");break}if(Array.isArray(e)){console.log(`ğŸ“¥ Importing ${e.length} cookies...`);let o=0,a=0,s=0;for(const t of e)try{const e=r(t,n.url);console.log("ğŸª Setting cookie:",e),await chrome.cookies.set(e),o++,console.log(`âœ… Set cookie: ${t.name}`)}catch(e){console.error(`âŒ Failed to set cookie: ${t.name}`,e),console.log("Problem cookie:",t),a++}const c=`æˆåŠŸå¯¼å…¥ ${o} ä¸ªCookie${a>0?`ï¼Œ${a} ä¸ªå¤±è´¥`:""}${s>0?`ï¼Œ${s} ä¸ªè·³è¿‡`:""}`;console.log(`ğŸ“Š Import complete: ${c}`),await t(c,0===a?"success":"warning")}else console.error("âŒ Invalid data format: not an array"),await t("å‰ªè´´æ¿ä¸­çš„æ•°æ®æ ¼å¼æ— æ•ˆ","error")}catch(e){console.error("âŒ Failed to parse cookie data:",e),await t("å¯¼å…¥å¤±è´¥ï¼šæ•°æ®æ ¼å¼é”™è¯¯","error")}break;case"copy-session-storage":console.log("ğŸ¯ é€šè¿‡å¿«æ·é”®è§¦å‘å¤åˆ¶æ“ä½œ"),chrome.tabs.query({active:!0,currentWindow:!0},(async function(e){if(e[0])try{const r=await chrome.scripting.executeScript({target:{tabId:e[0].id,allFrames:!0},function:()=>{const e={};for(let o=0;o<sessionStorage.length;o++){const t=sessionStorage.key(o);e[t]=sessionStorage.getItem(t)}return{frameId:window.frameElement?window.frameElement.id:0,data:e}}});r&&r.length>0?(o=r,console.log("ğŸ“¦ ä¼šè¯å­˜å‚¨æ•°æ®å·²ä¿å­˜åˆ°å†…å­˜ä¸­"),await t("ä¼šè¯å­˜å‚¨æ•°æ®å·²å¤åˆ¶ï¼","success")):(console.log("âŒ æœªæ‰¾åˆ°ä»»ä½•ä¼šè¯å­˜å‚¨æ•°æ®"),o=null,await t("æ²¡æœ‰æ‰¾åˆ°ä¼šè¯å­˜å‚¨æ•°æ®","error"))}catch(e){console.error("å¤åˆ¶ä¼šè¯å­˜å‚¨å¤±è´¥:",e),o=null,await t("å¤åˆ¶ä¼šè¯å­˜å‚¨å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°äº†è§£è¯¦æƒ…","error")}else console.error("âŒ æ²¡æœ‰æ‰¾åˆ°æ´»åŠ¨æ ‡ç­¾é¡µ")}));break;case"import-session-storage":console.log("ğŸ¯ é€šè¿‡å¿«æ·é”®è§¦å‘å¯¼å…¥æ“ä½œ");try{if(!o)return console.log("âŒ æ²¡æœ‰å¯å¯¼å…¥çš„æ•°æ®"),void await t("æ²¡æœ‰å¯å¯¼å…¥çš„æ•°æ®","error");await chrome.scripting.executeScript({target:{tabId:n.id},function:e=>{try{return e.forEach((e=>{const o=e.result.data;Object.entries(o).forEach((([e,o])=>{try{sessionStorage.setItem(e,o),console.log("âœ… æˆåŠŸå¯¼å…¥:",e)}catch(o){console.error("âŒ å¯¼å…¥å¤±è´¥:",e,o)}}))})),!0}catch(e){return console.error("å¯¼å…¥è¿‡ç¨‹ä¸­å‡ºé”™:",e),!1}},args:[o]}),console.log("âœ… å¯¼å…¥å®Œæˆ"),await t("ä¼šè¯å­˜å‚¨æ•°æ®å·²å¯¼å…¥ï¼","success")}catch(e){console.error("å¯¼å…¥ä¼šè¯å­˜å‚¨å¤±è´¥:",e),await t("å¯¼å…¥ä¼šè¯å­˜å‚¨å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°äº†è§£è¯¦æƒ…","error")}break;default:console.log("âš ï¸ Unknown command:",e)}}catch(e){console.error("âŒ Command execution failed:",e),await t("æ“ä½œå¤±è´¥: "+e.message,"error")}})),chrome.contextMenus.onClicked.addListener((async(r,n)=>{if("copySessionStorage"===r.menuItemId){console.log("ğŸ¯ è§¦å‘å¤åˆ¶ä¼šè¯å­˜å‚¨æ“ä½œ");try{const e=await chrome.scripting.executeScript({target:{tabId:n.id,allFrames:!0},function:()=>{const e={};for(let o=0;o<sessionStorage.length;o++){const t=sessionStorage.key(o);e[t]=sessionStorage.getItem(t)}return{frameId:window.frameElement?window.frameElement.id:0,data:e}}});e&&e.length>0?(o=e,console.log("ğŸ“¦ ä¼šè¯å­˜å‚¨æ•°æ®å·²ä¿å­˜åˆ°å†…å­˜ä¸­"),await t("ä¼šè¯å­˜å‚¨æ•°æ®å·²å¤åˆ¶ï¼","success")):(console.log("âŒ æœªæ‰¾åˆ°ä»»ä½•ä¼šè¯å­˜å‚¨æ•°æ®"),o=null,await t("æ²¡æœ‰æ‰¾åˆ°ä¼šè¯å­˜å‚¨æ•°æ®","error"))}catch(e){console.error("å¤åˆ¶ä¼šè¯å­˜å‚¨å¤±è´¥:",e),o=null,await t("å¤åˆ¶ä¼šè¯å­˜å‚¨å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°äº†è§£è¯¦æƒ…","error")}}else if("importSessionStorage"===r.menuItemId){console.log("ğŸ¯ è§¦å‘å¯¼å…¥ä¼šè¯å­˜å‚¨æ“ä½œ");try{if(!o)return console.log("âŒ æ²¡æœ‰å¯å¯¼å…¥çš„æ•°æ®"),void await t("æ²¡æœ‰å¯å¯¼å…¥çš„æ•°æ®","error");await chrome.scripting.executeScript({target:{tabId:n.id},function:e=>{try{return e.forEach((e=>{const o=e.result.data;Object.entries(o).forEach((([e,o])=>{try{sessionStorage.setItem(e,o),console.log("âœ… æˆåŠŸå¯¼å…¥:",e)}catch(o){console.error("âŒ å¯¼å…¥å¤±è´¥:",e,o)}}))})),!0}catch(e){return console.error("å¯¼å…¥è¿‡ç¨‹ä¸­å‡ºé”™:",e),!1}},args:[o]}),console.log("âœ… å¯¼å…¥å®Œæˆ"),await t("ä¼šè¯å­˜å‚¨æ•°æ®å·²å¯¼å…¥ï¼","success")}catch(e){console.error("å¯¼å…¥ä¼šè¯å­˜å‚¨å¤±è´¥:",e),await t("å¯¼å…¥ä¼šè¯å­˜å‚¨å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°äº†è§£è¯¦æƒ…","error")}}else if("copyCookies"===r.menuItemId){if(console.log("ğŸ¯ è§¦å‘å¤åˆ¶Cookieæ“ä½œ"),!n)return void console.error("âŒ æ²¡æœ‰æ‰¾åˆ°æ´»åŠ¨æ ‡ç­¾é¡µ");try{const o=new URL(n.url);console.log(`ğŸ” å¼€å§‹è·å–Cookiesï¼ŒURL: ${n.url}`);const r=await chrome.cookies.getAll({domain:o.hostname});console.log(`è·å–åˆ° ${r.length} ä¸ªcookies:`,r),r.length>0?(e=r,console.log("ğŸ“¦ Cookieæ•°æ®å·²ä¿å­˜åˆ°å†…å­˜ä¸­"),await t(`æˆåŠŸå¤åˆ¶ ${r.length} ä¸ª cookiesï¼`,"success")):(console.log("âŒ æœªæ‰¾åˆ°ä»»ä½•cookies"),e=null,await t("æœªæ‰¾åˆ°ä»»ä½• cookies","error"))}catch(o){console.error("å¤åˆ¶Cookieå¤±è´¥:",o),e=null,await t("å¤åˆ¶Cookieå¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°äº†è§£è¯¦æƒ…","error")}}else if("importCookies"===r.menuItemId){if(console.log("ğŸ¯ è§¦å‘å¯¼å…¥Cookieæ“ä½œ"),!n||!e)return console.error("âŒ æ²¡æœ‰æ‰¾åˆ°æ´»åŠ¨æ ‡ç­¾é¡µæˆ–æ²¡æœ‰å¯å¯¼å…¥çš„Cookieæ•°æ®"),void await t("æ²¡æœ‰å¯å¯¼å…¥çš„Cookieæ•°æ®","error");try{const o=new URL(n.url).hostname;console.log(`å‡†å¤‡å¯¼å…¥Cookieåˆ°åŸŸå: ${o}`);let r=0,a=0;for(const t of e)try{const e={name:t.name,value:t.value,domain:o,path:t.path||"/",secure:t.secure||!1,httpOnly:t.httpOnly||!1,sameSite:t.sameSite||"lax",url:n.url};t.expirationDate&&(e.expirationDate=t.expirationDate),console.log(`æ­£åœ¨è®¾ç½®cookie: ${e.name}`),await chrome.cookies.set(e),r++}catch(e){a++,console.error("è®¾ç½®cookieå¤±è´¥:",e)}r>0?await t(`æˆåŠŸå¯¼å…¥ ${r} ä¸ª cookiesï¼${a>0?` (${a}ä¸ªå¤±è´¥)`:""}`,"success"):await t("æ²¡æœ‰æˆåŠŸå¯¼å…¥ä»»ä½• cookies "+(a>0?` (${a}ä¸ªå¤±è´¥)`:""),"error")}catch(e){console.error("å¯¼å…¥Cookieå¤±è´¥:",e),await t("å¯¼å…¥Cookieå¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°äº†è§£è¯¦æƒ…","error")}}})),chrome.runtime.onMessage.addListener(((o,t,r)=>(console.log("ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯:",o),"storeCookies"===o.type?(e=o.cookies,r({success:!0})):"getCookies"===o.type&&r({cookies:e}),!0)))})();